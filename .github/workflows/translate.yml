name: Translate New Versions

on:
  workflow_dispatch:
    inputs:
      new_versions_map:
        description: 'JSON map of service ID to version arrays'
        required: false
      translate_all:
        description: 'Translate all untranslated versions'
        required: false
        default: 'false'

concurrency:
  group: "translate"
  cancel-in-progress: false

jobs:
  translate:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Show translation config
        run: |
          echo "TRANSLATION_ENGINE=${{ vars.TRANSLATION_ENGINE || 'auto' }}"
          echo "TRANSLATION_FALLBACK_CHAIN=${{ vars.TRANSLATION_FALLBACK_CHAIN || 'gemini,glm,openai,google,mock' }}"
          echo "GLM_MODEL=${{ vars.GLM_MODEL || 'glm-5' }}"

      - name: Parse and translate
        env:
          TRANSLATION_ENGINE: ${{ vars.TRANSLATION_ENGINE || 'auto' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_TRANSLATE_API_KEY: ${{ secrets.GOOGLE_TRANSLATE_API_KEY }}
          GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
          GLM_MODEL: ${{ vars.GLM_MODEL || 'glm-5' }}
          GLM_BASE_URL: ${{ vars.GLM_BASE_URL || 'https://api.z.ai/api/coding/paas/v4' }}
          TRANSLATION_FALLBACK_CHAIN: ${{ vars.TRANSLATION_FALLBACK_CHAIN || 'gemini,glm,openai,google,mock' }}
          NEW_VERSIONS_MAP: ${{ github.event.inputs.new_versions_map }}
          TRANSLATION_DEBUG_ENABLED: 'true'
          TRANSLATION_DEBUG_LOG_DIR: 'logs/translation'
          TRANSLATION_DEBUG_REDACT_TEXT: 'true'
        run: |
          if [ "${{ github.event.inputs.translate_all }}" = "true" ] || [ -z "$NEW_VERSIONS_MAP" ] || [ "$NEW_VERSIONS_MAP" = "{}" ]; then
            node scripts/parse-changelog.mjs
          else
            SERVICES=$(node -e "const m=JSON.parse(process.env.NEW_VERSIONS_MAP||'{}');console.log(Object.keys(m).join(' '))")
            for SERVICE in $SERVICES; do
              node scripts/parse-changelog.mjs --service "$SERVICE" --max-pages 2
            done
          fi
          node scripts/translate.mjs

      - name: Generate debug report
        if: always()
        env:
          TRANSLATION_DEBUG_LOG_DIR: 'logs/translation'
        run: |
          RUN_DATE=$(date +%Y-%m-%d)
          node scripts/report-translation-debug.mjs --date "$RUN_DATE" || echo "Report generation skipped (no logs)"

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translation-debug-${{ github.run_id }}
          path: |
            logs/translation/**
            reports/translation-debug/**
          retention-days: 14
          if-no-files-found: ignore

      - name: Guard legacy translation key
        run: |
          if rg -n '"translation"\s*:' data/services/*/translations/*.json; then
            echo "::error::Found legacy 'translation' key. All entries must use 'translated' key."
            exit 1
          else
            echo "No legacy translation keys found."
          fi

      - name: Generate commit message
        id: commit_message
        env:
          NEW_VERSIONS_MAP: ${{ github.event.inputs.new_versions_map }}
        run: |
          MSG=$(node -e "
            const map = JSON.parse(process.env.NEW_VERSIONS_MAP || '{}');
            const parts = Object.entries(map)
              .flatMap(([id, versions]) => versions.map(v => id + '@' + v))
              .join(', ');
            console.log(parts ? 'chore: add Korean translations for ' + parts : 'chore: add Korean translations');
          ")
          echo "message=$MSG" >> $GITHUB_OUTPUT

      - name: Commit translated data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git diff --staged --quiet || git commit -m "${{ steps.commit_message.outputs.message }}"
          git push

      - name: Trigger build
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-deploy.yml',
              ref: 'main'
            })

      # - name: Trigger notification
      #   if: github.event.inputs.translate_all != 'true'
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       await github.rest.actions.createWorkflowDispatch({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         workflow_id: 'notify.yml',
      #         ref: 'main',
      #         inputs: {
      #           new_versions_map: '${{ github.event.inputs.new_versions_map }}'
      #         }
      #       })
