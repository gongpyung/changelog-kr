name: Translate New Versions

on:
  workflow_dispatch:
    inputs:
      new_versions_map:
        description: 'JSON map of service ID to version arrays'
        required: false
      translate_all:
        description: 'Translate all untranslated versions'
        required: false
        default: 'false'

concurrency:
  group: "translate"
  cancel-in-progress: false

jobs:
  translate:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Parse and translate
        env:
          TRANSLATION_ENGINE: auto
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_TRANSLATE_API_KEY: ${{ secrets.GOOGLE_TRANSLATE_API_KEY }}
          NEW_VERSIONS_MAP: ${{ github.event.inputs.new_versions_map }}
        run: |
          if [ "${{ github.event.inputs.translate_all }}" = "true" ] || [ -z "$NEW_VERSIONS_MAP" ] || [ "$NEW_VERSIONS_MAP" = "{}" ]; then
            node scripts/parse-changelog.mjs
          else
            SERVICES=$(node -e "const m=JSON.parse(process.env.NEW_VERSIONS_MAP||'{}');console.log(Object.keys(m).join(' '))")
            for SERVICE in $SERVICES; do
              node scripts/parse-changelog.mjs --service "$SERVICE"
            done
          fi
          node scripts/translate.mjs

      - name: Guard legacy translation key
        run: |
          if rg -n '"translation"\s*:' data/services/*/translations/*.json; then
            echo "::warning::Found legacy 'translation' key in translation JSON files. Prefer 'translated' key."
          else
            echo "No legacy translation keys found."
          fi

      - name: Generate commit message
        id: commit_message
        env:
          NEW_VERSIONS_MAP: ${{ github.event.inputs.new_versions_map }}
        run: |
          MSG=$(node -e "
            const map = JSON.parse(process.env.NEW_VERSIONS_MAP || '{}');
            const parts = Object.entries(map)
              .flatMap(([id, versions]) => versions.map(v => id + '@' + v))
              .join(', ');
            console.log(parts ? 'chore: add Korean translations for ' + parts : 'chore: add Korean translations');
          ")
          echo "message=$MSG" >> $GITHUB_OUTPUT

      - name: Commit translated data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git diff --staged --quiet || git commit -m "${{ steps.commit_message.outputs.message }}"
          git push

      - name: Trigger build
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-deploy.yml',
              ref: 'main'
            })

      # - name: Trigger notification
      #   if: github.event.inputs.translate_all != 'true'
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       await github.rest.actions.createWorkflowDispatch({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         workflow_id: 'notify.yml',
      #         ref: 'main',
      #         inputs: {
      #           new_versions_map: '${{ github.event.inputs.new_versions_map }}'
      #         }
      #       })
